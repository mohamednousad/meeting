<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noush Alert System</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>

    <h1>Noush Global Connect (Alert Mode)</h1>
    <hr>

    <h3>Step 1: Your ID</h3>
    <p>Share this ID with your friend:</p>
    <div id="my-id" style="font-weight: bold; font-size: 20px;">Waiting for server...</div>
    <button onclick="copyId()">Copy ID</button>
    <hr>

    <h3>Step 2: Connect</h3>
    <p>Enter Friend's ID to Join:</p>
    <input type="text" id="remote-id" placeholder="Paste Friend ID here">
    <button onclick="joinCall()">Join Call</button>
    <hr>

    <h3>Video Feed</h3>
    <div style="border: 2px solid black; display: inline-block;">
        <p>Remote Video:</p>
        <video id="remote-video" autoplay playsinline width="400"></video>
    </div>
    <div style="border: 2px solid black; display: inline-block;">
        <p>My Local Video:</p>
        <video id="local-video" autoplay muted playsinline width="200"></video>
    </div>

    <script>
        // --- 1. SETUP VARIABLES ---
        const myIdDisplay = document.getElementById('my-id');
        const remoteVideo = document.getElementById('remote-video');
        const localVideo = document.getElementById('local-video');
        let localStream;
        let peer;

        // --- 2. CONFIGURATION (Google STUN) ---
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        // --- 3. START IMMEDIATELY ---
        // automatically ask for permissions on load to be ready
        window.onload = startApp;

        async function startApp() {
            try {
                // Get Screen + Mic permissions
                alert("Please Allow Screen and Microphone Access in the next popup.");
                
                const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });

                // Merge streams
                localStream = new MediaStream([
                    ...screenStream.getVideoTracks(),
                    ...audioStream.getAudioTracks()
                ]);

                // Show local video
                localVideo.srcObject = localStream;

                // Start PeerJS Connection
                initPeer();

            } catch (err) {
                alert("Error: You denied permissions or closed the popup. " + err);
            }
        }

        function initPeer() {
            peer = new Peer(null, peerConfig);

            // --- EVENT: Connected to Server ---
            peer.on('open', (id) => {
                myIdDisplay.innerText = id;
                alert("SUCCESS: Connected to PeerJS Server!\n\nYour ID is: " + id);
            });

            // --- EVENT: Error ---
            peer.on('error', (err) => {
                alert("ERROR: " + err.type + "\n" + err);
            });

            // --- EVENT: Disconnected from Server ---
            peer.on('disconnected', () => {
                alert("WARNING: Disconnected from PeerJS Server.");
            });

            // --- EVENT: Incoming Call ---
            peer.on('call', (call) => {
                // Ask user if they want to answer
                let accept = confirm("INCOMING CALL!\n\nSomeone is trying to connect. Answer?");
                
                if (accept) {
                    call.answer(localStream); // Send our stream back
                    alert("Call Answered! Connecting stream...");
                    
                    call.on('stream', (remoteStream) => {
                        alert("SUCCESS: Remote Stream Received!");
                        remoteVideo.srcObject = remoteStream;
                    });
                    
                    call.on('close', () => {
                        alert("Call Ended by remote user.");
                    });
                } else {
                    alert("Call Rejected.");
                }
            });
        }

        // --- 4. JOIN FUNCTION ---
        function joinCall() {
            const remoteId = document.getElementById('remote-id').value;
            if (!remoteId) {
                alert("Please enter a valid ID first!");
                return;
            }

            alert("Attempting to connect to: " + remoteId);

            const call = peer.call(remoteId, localStream);

            call.on('stream', (remoteStream) => {
                alert("SUCCESS: Connected to Friend! Video starting...");
                remoteVideo.srcObject = remoteStream;
            });

            call.on('error', (err) => {
                alert("Call Error: " + err);
            });
            
            call.on('close', () => {
                alert("Call Disconnected.");
            });
        }

        function copyId() {
            const id = myIdDisplay.innerText;
            navigator.clipboard.writeText(id);
            alert("ID Copied to Clipboard!");
        }
    </script>
</body>
</html>