<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Dev-Station | Multi-Network Voice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #e0e0e0; font-family: monospace; }
        .dev-card { background: #161b22; border: 1px solid #30363d; border-radius: 4px; }
        .status-pill { width: 12px; height: 12px; display: inline-block; border-radius: 50%; margin-right: 8px; }
        .online { background: #238636; box-shadow: 0 0 8px #238636; }
        .offline { background: #da3633; }
        #log-console { height: 200px; overflow-y: auto; background: #000; color: #00ff00; font-size: 0.8rem; padding: 10px; border: 1px solid #30363d; }
        .user-item { padding: 8px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
        .mic-active { animation: glow 1s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #238636; } to { box-shadow: 0 0 20px #238636; } }
    </style>
</head>
<body>

<div class="container-fluid py-4">
    <div class="row g-3">
        <div class="col-md-4">
            <div class="dev-card p-3 mb-3">
                <h6 class="text-uppercase text-muted border-bottom pb-2">System Authority</h6>
                <div class="mb-3">
                    <span id="state-indicator" class="status-pill offline"></span>
                    <span id="conn-status">HARDWARE_OFFLINE</span>
                </div>
                <div class="small mb-2 text-info">LOCAL_PEER_ID:</div>
                <div id="my-id" class="p-2 bg-dark border border-secondary mb-3 text-break text-warning">Awaiting Initialization...</div>
                
                <button id="init-btn" class="btn btn-outline-primary btn-sm w-100 mb-2">INITIALIZE_WEBRTC_STACK</button>
                
                <hr class="border-secondary">
                
                <div class="input-group input-group-sm mb-2">
                    <input type="text" id="remote-id" class="form-control bg-dark text-white border-secondary" placeholder="REMOTE_PEER_ID">
                    <button id="call-btn" class="btn btn-success" disabled>DIAL_LINK</button>
                </div>
            </div>

            <div class="dev-card p-3">
                <h6 class="text-uppercase text-muted border-bottom pb-2">Active Link Data</h6>
                <div id="peer-list">
                    <div class="text-muted small">No active media tracks...</div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="dev-card p-3 h-100">
                <h6 class="text-uppercase text-muted border-bottom pb-2">ICE_SIGNALING_LOGS (NAT Traversal Audit)</h6>
                <div id="log-console" class="mb-3"></div>
                
                <div class="row">
                    <div class="col-6">
                        <h6 class="text-uppercase text-muted small">VAD_ANALYSIS (Local)</h6>
                        <div class="progress bg-dark" style="height: 20px;">
                            <div id="vad-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-uppercase text-muted small">ICE_CANDIDATE_TYPE</h6>
                        <div id="ice-type" class="badge bg-secondary">UNKNOWN</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="remote-audio" autoplay playsinline></audio>



<script>
    const App = {
        peer: null,
        localStream: null,
        audioCtx: null,
        analyser: null,
        // Using Open Relay Project TURN servers for cross-network connectivity
        iceConfig: {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' },
                { 'urls': 'stun:stun1.l.google.com:19302' },
                {
                    urls: "turn:openrelay.metered.ca:80",
                    username: "openrelayproject",
                    credential: "openrelayprojectsecret",
                },
                {
                    urls: "turn:openrelay.metered.ca:443",
                    username: "openrelayproject",
                    credential: "openrelayprojectsecret",
                },
                {
                    urls: "turn:openrelay.metered.ca:443?transport=tcp",
                    username: "openrelayproject",
                    credential: "openrelayprojectsecret",
                }
            ],
            'iceTransportPolicy': 'all'
        }
    };

    const Logger = (msg, type = 'INFO') => {
        const consoleEl = document.getElementById('log-console');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        consoleEl.innerHTML += `<div>[${time}] <span class="text-info">${type}</span>: ${msg}</div>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
    };

    document.getElementById('init-btn').addEventListener('click', async () => {
        Logger("Initializing MediaDevices...");
        try {
            App.localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            App.audioCtx = new AudioContext();
            setupVAD(App.localStream);
            
            Logger("Hardware Ready. Initializing PeerJS with TURN failover...");
            
            App.peer = new Peer(App.iceConfig);

            App.peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
                document.getElementById('state-indicator').className = 'status-pill online';
                document.getElementById('conn-status').innerText = 'STACK_READY_WAITING_FOR_SIGNAL';
                document.getElementById('call-btn').disabled = false;
                Logger(`Peer Registered. ID: ${id}`);
            });

            App.peer.on('call', (call) => {
                Logger("Inbound Call Detected", "SIGNAL");
                call.answer(App.localStream);
                handleCall(call);
            });

            App.peer.on('error', (err) => {
                Logger(err.type, "FATAL_ERROR");
                console.error(err);
            });

            document.getElementById('init-btn').disabled = true;
            document.getElementById('init-btn').innerText = "ENGINE_RUNNING";
        } catch (e) {
            Logger(e.message, "HARDWARE_ERR");
        }
    });

    document.getElementById('call-btn').addEventListener('click', () => {
        const rId = document.getElementById('remote-id').value;
        if (!rId) return Logger("Empty Remote ID", "ERROR");
        
        Logger(`Dialing: ${rId}`, "SIGNAL");
        const call = App.peer.call(rId, App.localStream);
        handleCall(call);
    });

    function handleCall(call) {
        call.on('stream', (remoteStream) => {
            Logger("Media Stream Connected", "STREAM");
            const audio = document.getElementById('remote-audio');
            audio.srcObject = remoteStream;
            
            // Monitor ICE Connection State
            const pc = call.peerConnection;
            pc.oniceconnectionstatechange = () => {
                Logger(`ICE State: ${pc.iceConnectionState}`, "NETWORK");
                if(pc.iceConnectionState === 'connected') {
                    // Detect if using STUN or TURN
                    pc.getStats().then(stats => {
                        stats.forEach(report => {
                            if(report.type === 'remote-candidate') {
                                document.getElementById('ice-type').innerText = report.candidateType.toUpperCase();
                                Logger(`Routed via: ${report.candidateType}`, "NETWORK");
                            }
                        });
                    });
                }
            };

            updateUserList(call.peer, true);
        });

        call.on('close', () => {
            Logger("Session Terminated", "SIGNAL");
            updateUserList(call.peer, false);
        });
    }

    function setupVAD(stream) {
        const source = App.audioCtx.createMediaStreamSource(stream);
        App.analyser = App.audioCtx.createAnalyser();
        App.analyser.fftSize = 256;
        source.connect(App.analyser);
        const data = new Uint8Array(App.analyser.frequencyBinCount);

        function loop() {
            App.analyser.getByteFrequencyData(data);
            const volume = data.reduce((a, b) => a + b) / data.length;
            document.getElementById('vad-bar').style.width = `${Math.min(volume * 2, 100)}%`;
            requestAnimationFrame(loop);
        }
        loop();
    }

    function updateUserList(peerId, active) {
        const list = document.getElementById('peer-list');
        list.innerHTML = active ? `
            <div class="user-item">
                <span class="text-success">‚óè ${peerId.substring(0,8)}...</span>
                <span class="badge bg-primary">VOICE_ACTIVE</span>
            </div>
        ` : `<div class="text-muted small">No active media tracks...</div>`;
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>