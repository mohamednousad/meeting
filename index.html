<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Voice Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .box { background: #1e1e1e; padding: 40px; border-radius: 10px; text-align: center; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { margin-bottom: 5px; color: #00ff88; }
        p { color: #aaa; margin-bottom: 20px; }
        
        input { padding: 15px; font-size: 1.5rem; text-align: center; width: 120px; border-radius: 5px; border: none; margin: 10px; background: #333; color: white; }
        button { padding: 15px 30px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; margin: 5px; transition: 0.2s; }
        
        .btn-create { background: #00ff88; color: black; }
        .btn-join { background: #0088ff; color: white; }
        button:hover { opacity: 0.8; transform: scale(1.05); }

        #status { margin-top: 20px; font-weight: bold; color: #ffcc00; }
        .success { color: #00ff00 !important; }
    </style>
</head>
<body>

    <div class="box">
        <h1>Private Voice Call</h1>
        <p>Simple Global Audio Chat</p>

        <div id="setup-ui">
            <button class="btn-create" onclick="createRoom()">Create Room</button>
            <br><br>
            <span>OR JOIN FRIEND</span><br>
            <input type="number" id="room-code" placeholder="000">
            <button class="btn-join" onclick="joinRoom()">Join Call</button>
        </div>

        <div id="active-ui" style="display:none;">
            <h2 id="room-display" style="font-size: 3rem; margin: 10px;">...</h2>
            <p>Share this number with your friend</p>
        </div>

        <div id="status">Status: Waiting for action...</div>
        
        <audio id="remote-audio" autoplay></audio>
    </div>

    <script>
        // --- 1. CONFIGURATION (Google STUN for crossing countries) ---
        const peerConfig = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        let peer;
        let localStream;
        const statusEl = document.getElementById('status');
        const remoteAudio = document.getElementById('remote-audio');

        // --- 2. HOST LOGIC ---
        async function createRoom() {
            // Get Mic Permission first
            if (!await setupAudio()) return;

            // Generate Random 3-Digit ID
            const roomId = Math.floor(Math.random() * 900) + 100;
            
            // Connect to PeerJS Cloud
            // We use a prefix 'voice-app-' to ensure the ID is unique on their server
            peer = new Peer(`voice-app-${roomId}`, peerConfig);

            peer.on('open', (id) => {
                showActiveUI(roomId);
                statusEl.innerText = "Waiting for friend to join...";
            });

            // Answer incoming call automatically
            peer.on('call', (call) => {
                call.answer(localStream); // Send my voice back
                
                call.on('stream', (remoteStream) => {
                    playAudio(remoteStream);
                });
            });

            peer.on('error', (err) => alert("Error: " + err));
        }

        // --- 3. JOIN LOGIC ---
        async function joinRoom() {
            const roomId = document.getElementById('room-code').value;
            if (roomId.length !== 3) return alert("Please enter the 3-digit code!");

            // Get Mic Permission first
            if (!await setupAudio()) return;

            statusEl.innerText = "Connecting to server...";
            
            // Connect as a guest (random ID)
            peer = new Peer(null, peerConfig);

            peer.on('open', (id) => {
                statusEl.innerText = "Calling Room " + roomId + "...";
                
                // Call the Host
                const call = peer.call(`voice-app-${roomId}`, localStream);

                call.on('stream', (remoteStream) => {
                    playAudio(remoteStream);
                });

                call.on('error', (err) => {
                    statusEl.innerText = "Call Failed. Is the room ID correct?";
                });
            });
        }

        // --- 4. HELPERS ---
        async function setupAudio() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                return true;
            } catch (err) {
                alert("Microphone Access Denied! You cannot talk without a mic.");
                return false;
            }
        }

        function playAudio(stream) {
            statusEl.innerText = "CONNECTED! YOU CAN SPEAK NOW.";
            statusEl.classList.add('success');
            remoteAudio.srcObject = stream;
        }

        function showActiveUI(id) {
            document.getElementById('setup-ui').style.display = 'none';
            document.getElementById('active-ui').style.display = 'block';
            document.getElementById('room-display').innerText = id;
        }
    </script>
</body>
</html>