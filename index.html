<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostLink Voice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --text-primary: #f8fafc;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            padding: 20px;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            transition: all 0.3s ease;
        }

        .role-badge {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .room-display {
            font-size: 4rem;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: -2px;
            margin: 10px 0;
            font-family: 'Monaco', monospace;
        }

        .btn-custom {
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            width: 100%;
            border: none;
            transition: transform 0.2s;
        }
        .btn-custom:active { transform: scale(0.98); }
        
        .btn-host { background-color: var(--accent); color: white; }
        .btn-host:hover { background-color: var(--accent-hover); }

        .btn-join { background-color: #334155; color: white; margin-top: 10px; }
        .btn-join:hover { background-color: #475569; }

        .input-code {
            background: #0f172a;
            border: 2px solid #334155;
            color: white;
            font-size: 1.5rem;
            text-align: center;
            letter-spacing: 5px;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .input-code:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            display: none;
        }
        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .hidden { display: none !important; }

        /* Animations */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .live-indicator {
            width: 10px;
            height: 10px;
            background-color: #4ade80;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="view-home" class="glass-card">
        <div class="mb-4">
            <i class="fas fa-ghost fa-3x" style="color: var(--accent);"></i>
        </div>
        <h3>Welcome, <span id="my-name" style="color: #a5b4fc;">User</span></h3>
        <p class="text-secondary mb-4">Secure, peer-to-peer voice link.</p>
        
        <button class="btn btn-custom btn-host" onclick="setupHost()">
            <i class="fas fa-satellite-dish me-2"></i> Create New Room
        </button>
        
        <div class="my-3 text-secondary" style="font-size: 0.8rem;">— OR JOIN EXISTING —</div>
        
        <input type="number" id="join-code-input" class="form-control input-code" placeholder="000">
        <button class="btn btn-custom btn-join" onclick="setupJoin()">
            <i class="fas fa-sign-in-alt me-2"></i> Join Room
        </button>
    </div>

    <div id="view-host" class="glass-card hidden">
        <span class="role-badge">HOSTING</span>
        <h2 class="text-secondary" style="font-size: 1rem;">YOUR ROOM CODE</h2>
        <div id="host-room-code" class="room-display">...</div>
        <p class="text-secondary small">Share this number with your friend.</p>
        
        <div class="spinner-border text-primary mt-3" role="status"></div>
        <div class="mt-2 text-muted small">Waiting for connection...</div>

        <div id="host-confirmation" class="status-message status-success">
            <div class="d-flex align-items-center justify-content-center">
                <span class="live-indicator"></span>
                <strong><span id="guest-name-display">Guest</span> Connected!</strong>
            </div>
        </div>
    </div>

    <div id="view-join" class="glass-card hidden">
        <span class="role-badge">JOINING</span>
        <div class="mt-4">
            <div class="spinner-grow text-info" role="status"></div>
        </div>
        <h4 class="mt-3">Connecting to Room <span id="join-room-display">...</span></h4>
        
        <div id="join-confirmation" class="status-message status-success">
            <div class="d-flex align-items-center justify-content-center">
                <span class="live-indicator"></span>
                <strong>Connected to Host!</strong>
            </div>
        </div>
    </div>

    <audio id="remote-audio" autoplay playsinline></audio>

</div>

<script>
    // --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyCSIOclG4YkP0rXH036kXPMJ9Dcf1euKp8",
  authDomain: "ghostlink-e94f0.firebaseapp.com",
  databaseURL: "https://ghostlink-e94f0-default-rtdb.firebaseio.com",
  projectId: "ghostlink-e94f0",
  storageBucket: "ghostlink-e94f0.firebasestorage.app",
  messagingSenderId: "439838193122",
  appId: "1:439838193122:web:3130b500e67e3c1fc975bb",
  measurementId: "G-RL16X17VZT",
};
    const rtcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { 
                urls: 'turn:staticauth.openrelay.metered.ca:80', 
                username: 'openrelayproject', 
                credential: 'openrelayprojectsecret' 
            },
            { 
                urls: 'turn:staticauth.openrelay.metered.ca:443', 
                username: 'openrelayproject', 
                credential: 'openrelayprojectsecret' 
            }
        ]
    };

    // --- NAMES & ID ---
    const ADJECTIVES = ["Cyber", "Neon", "Quantum", "Hyper", "Solar", "Lunar", "Astro"];
    const NOUNS = ["Wolf", "Ghost", "Pilot", "Scout", "Ninja", "Falcon", "Nomad"];
    
    function getRandomName() {
        const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
        const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
        return `${adj}${noun}`;
    }

    const myName = getRandomName();
    const myId = Math.random().toString(36).substr(2, 9);
    
    document.getElementById('my-name').innerText = myName;

    // --- STATE ---
    let db, localStream, peerConnection;
    let currentRoomId = null;

    // --- INITIALIZATION ---
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch(e) {
        console.error("Firebase Error", e);
        alert("Configuration Error: Check console");
    }

    // --- UI FLOW ---

    async function getMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            return true;
        } catch (err) {
            alert("Microphone access is required to connect.");
            return false;
        }
    }

    async function setupHost() {
        const permitted = await getMedia();
        if (!permitted) return;

        // Generate 3 digit code
        currentRoomId = Math.floor(100 + Math.random() * 900).toString();
        
        // Update UI
        document.getElementById('view-home').classList.add('hidden');
        document.getElementById('view-host').classList.remove('hidden');
        document.getElementById('host-room-code').innerText = currentRoomId;

        // Create Room in DB
        const roomRef = db.ref(`rooms/${currentRoomId}`);
        roomRef.set({
            hostId: myId,
            hostName: myName,
            status: 'waiting'
        });
        roomRef.onDisconnect().remove(); // Auto-cleanup

        // Listen for Guest Signals
        listenForSignals(true);
    }

    async function setupJoin() {
        const code = document.getElementById('join-code-input').value;
        if (code.length !== 3) {
            alert("Please enter a valid 3-digit room code.");
            return;
        }

        const permitted = await getMedia();
        if (!permitted) return;

        currentRoomId = code;

        // Check if room exists
        const roomRef = db.ref(`rooms/${currentRoomId}`);
        roomRef.once('value', async (snapshot) => {
            if (snapshot.exists()) {
                // UI Update
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-join').classList.remove('hidden');
                document.getElementById('join-room-display').innerText = currentRoomId;

                // Start WebRTC as Caller
                initializePeerConnection(true); 
            } else {
                alert("Room not found!");
            }
        });
    }

    // --- WEBRTC SIGNALING LOGIC ---

    function listenForSignals(isHost) {
        // If Host: Wait for 'offer' from Guest
        // If Guest: Wait for 'answer' from Host
        
        const signalRef = db.ref(`rooms/${currentRoomId}/signals`);
        
        signalRef.on('child_added', async (snapshot) => {
            const data = snapshot.val();
            if (data.sender === myId) return; // Ignore own messages

            if (!peerConnection) initializePeerConnection(false);

            if (data.type === 'offer' && isHost) {
                // Host receives Offer -> Sets Remote -> Sends Answer
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                signalRef.push({ type: 'answer', sdp: answer, sender: myId });
                
                // Show Guest Name (from data or just generic)
                document.getElementById('host-confirmation').style.display = 'block';
                document.querySelector('.spinner-border').style.display = 'none';

            } else if (data.type === 'answer' && !isHost) {
                // Guest receives Answer -> Sets Remote
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                
                // Show Confirmation
                document.getElementById('join-confirmation').style.display = 'block';
                document.querySelector('.spinner-grow').style.display = 'none';

            } else if (data.type === 'candidate') {
                // Add ICE Candidate
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (e) { console.error("Error adding candidate", e); }
            }
        });
    }

    function initializePeerConnection(isInitiator) {
        peerConnection = new RTCPeerConnection(rtcConfig);

        // 1. Add Local Audio
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // 2. Handle Remote Audio
        peerConnection.ontrack = (event) => {
            const remoteAudio = document.getElementById('remote-audio');
            remoteAudio.srcObject = event.streams[0];
        };

        // 3. Handle ICE Candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                db.ref(`rooms/${currentRoomId}/signals`).push({
                    type: 'candidate',
                    candidate: event.candidate.toJSON(),
                    sender: myId
                });
            }
        };

        // 4. If Initiator (Guest joining), create Offer
        if (isInitiator) {
            createAndSendOffer();
            // Start listening for the Answer
            listenForSignals(false);
        }
    }

    async function createAndSendOffer() {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        db.ref(`rooms/${currentRoomId}/signals`).push({
            type: 'offer',
            sdp: offer,
            sender: myId,
            senderName: myName
        });
    }

</script>
</body>
</html>